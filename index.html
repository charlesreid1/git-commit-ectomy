



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="./">
      <meta name="generator" content="mkdocs-0.17.3, mkdocs-material-2.7.2">
    
    
      
        <title>git-commit-ectomy</title>
      
    
    
      <link rel="stylesheet" href="./assets/stylesheets/application.8d40d89b.css">
      
        <link rel="stylesheet" href="./assets/stylesheets/application-palette.6079476c.css">
      
    
    
      <script src="./assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
      <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">
    
    
      <link rel="stylesheet" href="./css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="orange">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="drawer"></label>
    
      <a href="#git-commit-ectomy" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="." title="git-commit-ectomy" class="md-header-nav__button md-logo">
          
            <i class="md-icon">announcement</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                git-commit-ectomy
              </span>
              <span class="md-header-nav__topic">
                Index
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="drawer">
    <span class="md-nav__button md-logo">
      
        <i class="md-icon">announcement</i>
      
    </span>
    git-commit-ectomy
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="toc">
    
      
    
    
    <a href="." title="Index" class="md-nav__link md-nav__link--active">
      Index
    </a>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="git-commit-ectomy">git-commit-ectomy</h1>
<p>Perform a git-commit-ectomy to forever remove problematic commits from your repo history.</p>
<p>This uses the <a href="https://tinyurl.com/git-commit-ectomy">git-forget-blob.sh</a> script from @nachoparker.</p>
<p><img alt="git-commit-ectomy main banner image" src="./img/git-commit-ectomy.jpg" /></p>
<h1 id="requirements">requirements</h1>
<p>This guide utilizes GNU xargs. 
You should run it on Linux, 
or use Homebrew's gxargs if 
on a Mac.</p>
<h1 id="demo-surgery">demo surgery</h1>
<p>Clone an example repo for performing surgery:</p>
<pre><code>$ git clone https://github.com/charlesreid1/git-commit-ectomy-example
</code></pre>

<h2 id="how-to-make-a-fat-file">how to make a fat file</h2>
<p>Use <code>dd</code> to create files by assembling 
a specified number of bits.
For example, to create a 10 MB file:</p>
<pre><code class="text">$ dd if=/dev/urandom of=my_big_fat_file bs=1048576 count=10
</code></pre>

<p><strong>Important:</strong> You must use <code>/dev/urandom</code> with a non-zero block size.
If you use <code>/dev/zeros</code> then each file will be identical and git 
will not store them separately. Then your surgery will go very badly.</p>
<p><strong>Note:</strong> <code>1048576 = 2^20</code> bytes comes from
1 KB = <code>2^10</code> bytes, and 1 MB = <code>2^10</code> KB, 
for a total of <code>2^20</code> bytes per megabyte.</p>
<p>count = 10 means we make 10 1mb blocks.</p>
<h2 id="make-several-fat-files">make several fat files</h2>
<p>Crank them out. bat cat dat fat rat!</p>
<pre><code>dd if=/dev/urandom of=bat bs=1048576 count=10
dd if=/dev/urandom of=cat bs=1048576 count=10
dd if=/dev/urandom of=dat bs=1048576 count=10
dd if=/dev/urandom of=fat bs=1048576 count=10
dd if=/dev/urandom of=rat bs=1048576 count=10
</code></pre>

<p>Make sure they are the correct size:</p>
<pre><code>$ ls -lhg
-rw-r--r--   1 staff    10M Apr 10 18:30 bat
-rw-r--r--   1 staff    10M Apr 10 18:30 cat
-rw-r--r--   1 staff    10M Apr 10 18:30 dat
-rw-r--r--   1 staff    10M Apr 10 18:30 fat
-rw-r--r--   1 staff    10M Apr 10 18:30 rat
</code></pre>

<p>Also make sure they are unique (hence <code>/dev/random</code> and not <code>/dev/zero</code>):</p>
<pre><code>$ for i in `/bin/ls -1 *at`; do
    md5 ${i}
done

MD5 (bat) = 140c7d1e5a12c0eb2fefd5529250a280
MD5 (cat) = 9345ca4033c7e42fb009e3b8014570dc
MD5 (dat) = fadc3114fe9a70f688eba0db4e0dc7a9
MD5 (fat) = 39e98200043e438f9070369989b2d964
MD5 (rat) = 77b1c3077041078fd1f371b1bb7dd6e4
</code></pre>

<h2 id="commit-files">commit files</h2>
<p>Add the files to the repo in <em>separate commits</em>:</p>
<pre><code>for item in bat cat dat fat rat; do
    git add ${item} &amp;&amp; git commit ${item} -m &quot;Adding ${item}&quot;
done

git push origin master
</code></pre>

<p>I also added two dummy files <code>foo.txt</code> and <code>bar.txt</code> 
to illustrate the impact of the surgery on 
commit history.</p>
<p>Now you should see everything in the commit history:</p>
<p><img alt="Repo commit history" src="./img/history.png" /></p>
<p>Locally in git log:</p>
<pre><code>$ git log --oneline
fd76938 Add bar.txt
8a86eaf Add foo.txt
c50a272 Adding rat
423ede3 Adding fat
b56c10b Adding dat
beb8b4f Adding cat
84d894e Adding bat
</code></pre>

<h2 id="prep-for-surgery">prep for surgery</h2>
<p>Use <a href="https://tinyurl.com/git-commit-ectomy">git-forget-blob.sh</a>
to forget the blob. Start by downloading it:</p>
<pre><code>$ wget https://tinyurl.com/git-forget-blob-sh -O git-forget-blob.sh
$ chmod +x git-forget-blob.sh
</code></pre>

<p>If you are on a Mac, edit the file to change
2 occurrences of <code>xargs</code> to <code>gxargs</code>.</p>
<p>To use it:</p>
<pre><code>        ./git-forget-blob.sh &lt;name-of-file&gt;
</code></pre>

<h2 id="git-rm">git rm</h2>
<p>Start by checking the size of the repo:</p>
<pre><code>$ du -hs .git
 50M    .git
</code></pre>

<p>Now remove <code>dat</code> using <code>git rm</code>:</p>
<pre><code>$ git rm dat
$ git commit dat -m 'Removing dat'
$ git push origin master
</code></pre>

<p>This, of course, does not change the size of the repo.
If we clone a fresh copy from Github, the size of the 
repo is still the same:</p>
<pre><code>$ du -hs .git
 50M    .git
</code></pre>

<p>Git is cursed with perfect memory, and will not
forget a large file that's been added to the repo.</p>
<h2 id="git-forget-blob">git forget blob</h2>
<p>We use <code>git-forget-blob.sh</code> to permanenty remove 
<code>dat</code> from the repo history and rewrite all commits
since the file was added:</p>
<pre><code>$ ./git-forget-blob.sh dat
Counting objects: 23, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (22/22), done.
Writing objects: 100% (23/23), done.
Total 23 (delta 6), reused 0 (delta 0)
Rewrite 84d894e39d63bbea54a7b8d3d1c85c588adff7ae (1/8) (0 seconds pRewrite beb8b4f2fbb257c0d6098620de7a8df5d7dd74ed (2/8) (0 seconds pRewrite b56c10bafeb95eece9880aa1a52cfc3e4e99045e (3/8) (0 seconds passed, remaining 0 predicted)    rm 'dat'
Rewrite 423ede37f4d75dbb7a1b8020c561c4d7a926a97f (4/8) (0 seconds passed, remaining 0 predicted)    rm 'dat'
Rewrite c50a2724f6d722002133b04b0f63f271b861ff9c (5/8) (0 seconds passed, remaining 0 predicted)    rm 'dat'
Rewrite 8a86eafbb5b669120fa1073cfa7567bbebf2fb2e (6/8) (0 seconds passed, remaining 0 predicted)    rm 'dat'
Rewrite fd769386dcd32354bad57e8eb057ae8adb2b3c9b (7/8) (0 seconds passed, remaining 0 predicted)    rm 'dat'
Rewrite d0587c525a5f64d02b1cb46c04261ab285c907f9 (8/8) (0 seconds passed, remaining 0 predicted)
Ref 'refs/heads/master' was rewritten
Counting objects: 20, done.
Delta compression using up to 4 threads.
Compressing objects: 100% (19/19), done.
Writing objects: 100% (20/20), done.
Total 20 (delta 6), reused 8 (delta 0)
</code></pre>

<p>Now check if it worked:</p>
<pre><code>$ du -hs .git
 40M    .git
</code></pre>

<p>Success!</p>
<h2 id="how-it-worked">how it worked</h2>
<p>If we check the git log we can see what happened - all commits involving <code>dat</code> were rewritten. Because git uses the prior commit's hash to make the next commit's hash, <em>we will rewrite every commit since the first time <code>dat</code> was added to the repo</em>:</p>
<p>New log:</p>
<pre><code>$ git log --oneline
3c10144 Removing dat
6f7b8f2 Add bar.txt
3f70da5 Add foo.txt
5406c1a Adding rat
df458d0 Adding fat
5f6e932 Adding dat
beb8b4f Adding cat
84d894e Adding bat
</code></pre>

<p>Compare to the old log:</p>
<pre><code>$ git log --oneline
d0587c5 Removing dat
fd76938 Add bar.txt
8a86eaf Add foo.txt
c50a272 Adding rat
423ede3 Adding fat
b56c10b Adding dat
beb8b4f Adding cat
84d894e Adding bat
</code></pre>

<p>Note that the "Add cat" commit IDs are identical, 
but every commit after <code>dat</code> was added to the repo is changed. </p>
<p>This is because each commit ID is computed using the hash of the prior commit, 
so if we change one commit ID in history, we change all subsequent commit IDs.</p>
<h2 id="stitch-the-patient-back-up">stitch the patient back up</h2>
<p>Of course, for surgeons, as for airline pilots,
if the last step is screwed up, nothing else counts.</p>
<p>We asked git to forget a file, which it did, 
but that required modifying commits in the 
git history, which required re-calculating
commit hashes.</p>
<p>At this point, we have two separate, parallel 
<code>master</code> branches that split when our 
file <code>dat</code> was added to the repo.</p>
<p>If we simply push our branch to the Github remote,
we will have a huge headache: every commit will have 
a duplicate, the old branch and the new branch,
and will show up side-by-side.</p>
<p>To do this correctly, we need to use the force
when we push:</p>
<pre><code>$ git push origin master --force
</code></pre>

<p>This will ensure that Github does not keep duplicate
copies of all commits.</p>
<p>Here is a screenshot of the repo on github before 
we ran <code>git-forget-blob</code>:</p>
<p><img alt="Commit history before git-forget-blob" src="./img/before.png" /></p>
<p>And a screenshot of the repo after:</p>
<p><img alt="Commit history after git-forget-blob" src="./img/after.png" /></p>
<h1 id="tips-for-surgery">tips for surgery</h1>
<p><strong>Size up your patient.</strong></p>
<p>This one-liner lists the 40 largest files in the repo
(modify the tail line to change the number):</p>
<pre><code>$ git rev-list --all --objects | \
     sed -n $(git rev-list --objects --all | \
     cut -f1 -d' ' | \
     git cat-file --batch-check | \
     grep blob | \
     sort -n -k 3 | \
     \
     tail -n40 | \
     \
     while read hash type size; do
          echo -n &quot;-e s/$hash/$size/p &quot;;
     done) | \
     sort -n -k1
</code></pre>

<p><strong>Get your patient some insurance.</strong> Back up any files 
you want to remove but keep.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright 2018 Charles Reid
          </div>
        
        powered by
        <a href="http://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="./assets/javascripts/application.0cf9b500.js"></script>
      
      <script>app.initialize({version:"0.17.3",url:{base:"."}})</script>
      
        <script src="./search/require.js"></script>
      
        <script src="./search/search.js"></script>
      
    
    
      
    
  </body>
</html>
