



<!DOCTYPE html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
      
        <link rel="canonical" href="https://pages.charlesreid1.com/git-commit-ectomy/ohfk/">
      
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="..">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-3.0.3">
    
    
      
        <title>Oh F&!k: Please Send Backup - git-commit-ectomy</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/application.451f80e5.css">
      
        <link rel="stylesheet" href="../assets/stylesheets/application-palette.22915126.css">
      
      
        
        
        <meta name="theme-color" content="#fb8c00">
      
    
    
      <script src="../assets/javascripts/modernizr.1aa3b519.js"></script>
    
    
      <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
      
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../assets/fonts/material-icons.css">
    
      <link rel="stylesheet" href="../css/custom.css">
    
    
  </head>
  
    
    
    <body dir="ltr" data-md-color-primary="orange" data-md-color-accent="orange">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="../#oh-fk-please-send-backup" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <header class="md-header" data-md-component="header">
  <nav class="md-header-nav md-grid">
    <div class="md-flex">
      <div class="md-flex__cell md-flex__cell--shrink">
        <a href="https://pages.charlesreid1.com/git-commit-ectomy/" title="git-commit-ectomy" class="md-header-nav__button md-logo">
          
            <i class="md-icon">announcement</i>
          
        </a>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        <label class="md-icon md-icon--menu md-header-nav__button" for="__drawer"></label>
      </div>
      <div class="md-flex__cell md-flex__cell--stretch">
        <div class="md-flex__ellipsis md-header-nav__title" data-md-component="title">
          
            
              <span class="md-header-nav__topic">
                git-commit-ectomy
              </span>
              <span class="md-header-nav__topic">
                Oh F&!k: Please Send Backup
              </span>
            
          
        </div>
      </div>
      <div class="md-flex__cell md-flex__cell--shrink">
        
          
            <label class="md-icon md-icon--search md-header-nav__button" for="__search"></label>
            
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
          
        
      </div>
      
        <div class="md-flex__cell md-flex__cell--shrink">
          <div class="md-header-nav__source">
            


  


  <a href="https://git.charlesreid1.com/charlesreid1/git-commit-ectomy" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      charlesreid1/git-commit-ectomy
    </div>
  </a>

          </div>
        </div>
      
    </div>
  </nav>
</header>
    
    <div class="md-container">
      
        
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://pages.charlesreid1.com/git-commit-ectomy/" title="git-commit-ectomy" class="md-nav__button md-logo">
      
        <i class="md-icon">announcement</i>
      
    </a>
    git-commit-ectomy
  </label>
  
    <div class="md-nav__source">
      


  


  <a href="https://git.charlesreid1.com/charlesreid1/git-commit-ectomy" title="Go to repository" class="md-source" data-md-source="">
    
    <div class="md-source__repository">
      charlesreid1/git-commit-ectomy
    </div>
  </a>

    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href=".." title="Index" class="md-nav__link">
      Index
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../easy/" title="Git-Commit-Ectomy the Easy Way: Single Branch" class="md-nav__link">
      Git-Commit-Ectomy the Easy Way: Single Branch
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../branches/" title="Complications: Dealing with Branches" class="md-nav__link">
      Complications: Dealing with Branches
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../transplant/" title="Performing Transplants with Patch" class="md-nav__link">
      Performing Transplants with Patch
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Oh F&!k: Please Send Backup
      </label>
    
    <a href="./" title="Oh F&!k: Please Send Backup" class="md-nav__link md-nav__link--active">
      Oh F&!k: Please Send Backup
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-first-case-users-pushing-old-history" title="the first case: users pushing old history" class="md-nav__link">
    the first case: users pushing old history
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-second-case-scrubbling-multiple-attempts" title="the second case: scrubbling multiple attempts" class="md-nav__link">
    the second case: scrubbling multiple attempts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-third-case-a-surgeons-nightmare" title="the third case: a surgeon's nightmare" class="md-nav__link">
    the third case: a surgeon's nightmare
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#the-first-case-users-pushing-old-history" title="the first case: users pushing old history" class="md-nav__link">
    the first case: users pushing old history
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-second-case-scrubbling-multiple-attempts" title="the second case: scrubbling multiple attempts" class="md-nav__link">
    the second case: scrubbling multiple attempts
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-third-case-a-surgeons-nightmare" title="the third case: a surgeon's nightmare" class="md-nav__link">
    the third case: a surgeon's nightmare
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="oh-fk-please-send-backup">Oh F&amp;!k: Please Send Backup</h1>
<p><img alt="Painting: The Gross Clinic (Eakins 1875)" src="../img/eakins-the-gross-clinic-1875.jpg" /></p>
<p><br />
<br /></p>
<p>When you use the single-branch procedure
instead of the multi-branch procedure...
bad things happen.</p>
<p>Possible complications to all of this include:</p>
<ul>
<li>
<p>Users who did not get the memo about the entire history
    of the repository being rewritten, who did not 
    listen when they were told to clone a fresh copy,
    and who pushed directly to master even though
    they were told repeatedly not to, so then you
    end up with the entire old history being pushed
    to the remote. (Deal with this proactively by
    protecting the master branch!)</p>
</li>
<li>
<p>Accidentally carrying out the procedure multiple times,
    resulting in 2, 3, 4, even 5 copies of each commit,
    and the duplicate commits simply refuse to die;</p>
</li>
<li>
<p>A confusing, tangled, messy commit history that is
    completely uninterpretable</p>
</li>
</ul>
<h3 id="the-first-case-users-pushing-old-history">the first case: users pushing old history</h3>
<p>When the git-commit-ectomy is complete, it is recommended
that you turn on branch protection right away. But in case
you did not, and a user pushed the old history to the remote,
here is how to deal.</p>
<p>From a copy of the repository with <em>only</em> the new history
(this is going to be the copy of the repository that is
on the surgeon's computer, preferrably the repo in which
the git-commit-etomy was originally performed),
run the command <code>git push origin master --force</code>
(where <code>origin</code> is the remote with the duplicate history,
and <code>master</code> is the name of the branch you're pushing. 
Replace these with whatever remote/branch names you are
using.)</p>
<p>Turn on branch protection immediately afterwards.</p>
<p><strong>If you do not have a copy of the repository with
<em>only</em> the new history</strong> (i.e., if you removed the
copy of the repository in which the git-commit-ectomy
was performed), you <em>can</em> still separate
the old and new histories. However, you <em>must</em> have
a copy of the old git log and/or the new git log,
so that you have some way of knowing which commits
belong to which history. If you have this info,
continue on to "the second case."</p>
<h3 id="the-second-case-scrubbling-multiple-attempts">the second case: scrubbling multiple attempts</h3>
<p>If you have performed a git-commit-ectomy multiple times,
and the duplicate commits are simply piling up and will 
not go away, you will need to use either a git rebase
or a git cherry pick operation.</p>
<p>Find the branch that you want to keep, and the commit
at which to start the new branch with the new history.</p>
<p>Then rebase or cherry pick any missing commits onto it.</p>
<p>Finally, remove all other branches on the remote.</p>
<p><strong>Example:</strong> Suppose we are trying to fix the history
of the <code>master</code> branch, which is a mess, by creating
a new branch <code>new_master</code> that has an improved and 
cleaned-up version of the <code>master</code> branch history.</p>
<p>We start by checking out the particular commit where
we wish <code>new_master</code> to diverge from <code>master</code>:</p>
<pre><code>git checkout &lt;hash-of-commit-to-split-at&gt;   # starting point for new branch
git branch new_master                       # create new branch
git checkout new_master                     # switch to new branch
</code></pre>

<p>Next, we modify the repository by making commits,
doing git rebase and git cherry pick operations,
and creating a new branch with a long and totally
separate commit history from master.</p>
<pre><code>...make some commits...
...rebase some stuff...
...cherry pick some stuff...
...now new branch has a long and totally different 
    commit history from master...
</code></pre>

<p>Finally, when the <code>new_master</code> branch is ready, push it
to the remote (e.g., <code>origin</code>):</p>
<pre><code>git push origin new_master                  # push all the new stuff to remote &quot;origin&quot;
</code></pre>

<p>The last step is to delete all other branches except for
the <code>new_master</code> branch, so that we don't preserve the 
messy history of the <code>master</code> branch. (The whole point of
the <code>new_master</code> branch was to clean it up.)</p>
<p>Deleting the master branch on the remote is a two step 
operation: first, delete the branch locally, then push
the deleted "ghost branch" to the remote (which will
propagate the deletion of the branch):</p>
<pre><code>git branch -D master                        # delete git branch master locally
git push origin :master                     # propagate deletion of branch &quot;master&quot; to remote &quot;origin&quot;
</code></pre>

<p>Note the syntax for deleting a branch is:</p>
<pre><code>git push &lt;name-of-remote&gt; :&lt;name-of-branch-to-delete&gt;
</code></pre>

<p>(If you have trouble removing the remote branches, 
double-check your syntax is right, and make sure you
use the <code>--force</code> flag.)</p>
<h3 id="the-third-case-a-surgeons-nightmare">the third case: a surgeon's nightmare</h3>
<p>If you have an absolute clusterf--k of a commit history,
you need a gifted surgeon. The more gifted the surgeon,
the more of your repo history you'll be able to retain.</p>
<p>Here is a minimal-complications method that removes more 
of your history than you'd probably want.</p>
<p>The method here is to leapfrog a whole series of 
complicated splits, merges, rebases, and other tangles,
and jump directly to a point in the repo where things 
are saner and calmer. This is done by creating two commits
(two repo states) that are exactly identical, and which
can be used as the source and destination of a git rebase 
operation.</p>
<p>To illustrate: suppose we have a tangled set of changes
that all added or modified large files in the repository,
and we wish to simply forget the whole thing ever happened.
This method will leapfrog every commit between commit A and
commit D.</p>
<pre><code>The Tangled Mess (Before):

A       B                       C   D   E (master)
o-------o-------o-------o-------o---o---o
         \             /       / 
          o---o---o---o       /
           \       \         /
            o---o---o---o---o




The Fixed Mess (After):

       D'   E' (new_master)
       o----o
      /
     /       (old history 
    o          is removed)
    A
</code></pre>

<p>We start by adding one new commit D' to the clusterf--ked branch.
This will compress all of the changes between A and D into 
a single commit. The state of the repository at D' should
match precisely the state of the repository at commit D:</p>
<pre><code>                                        D'
       ---------------------------------o
      /
     /      B                       C   D   E
 A  o-------o-------o-------o-------o---o---o
             \             /       / 
              o---o---o---o       /
               \       \         /
                o---o---o---o---o
</code></pre>

<p>To do this, check out the repo commit where the
clusterf--k is gone and when things are saner and
calmer (that is, commit A):</p>
<pre><code>git checkout &lt;commit-hash-for-A&gt;
</code></pre>

<p>Create a new branch at commit A, called <code>new_master</code>,</p>
<pre><code>git branch new_master
git checkout new_master
</code></pre>

<p>Now, add a commit at A that will bring the repository into the 
<em>exact</em> same state as the (clusterf--ked) branch (that is, commit D).
To do this, copy every single file present in the folder at commit D,
into the repository staging area for commit D'.</p>
<p>You must copy every single file that is in that folder in commit D,
<em>excatly, word for word, character for character</em>, into D'.</p>
<p>If any files are in A but not in D, those files
are extra and can be left alone without a problem.  </p>
<p>If any files are in D but not in A, you <em>must</em> 
add those files in when you create commit D'.</p>
<p>Once your staged commit D' matches the staged commit D,
commit your changes. Tag these two commits, D and D',
as your "stargates" - commit D is your stargate source,
and commit D' is your stargate destination. These commits
are linked because the repository is in exactly the same
state between commit D and commit D'.</p>
<p>The last step is to rebase any commits that were made
after the mess, that is, made after commit D, onto the new
cleaner history. We do this using the syntax:</p>
<pre><code>git rebase --onto &lt;new-head-base&gt; &lt;old-head-base&gt; &lt;branch-to-rebase&gt;
</code></pre>

<p>or, in terms of the stargate source and destination:</p>
<pre><code>git rebase --onto &lt;stargate-dest&gt; &lt;stargate-src&gt; &lt;branch-to-rebase&gt;
</code></pre>

<p>or, in terms of commits D and D': </p>
<pre><code>git rebase --onto  D'  D  E
</code></pre>

<p>That allows you to take any commits made on D and rebase
them onto D'. That way, you can throw away the messy part
of the commit history but preserve all of the remaining
commit history. </p>
<p>Note that you will lose all information about commits 
that are not rebased or cherry picked, i.e., all the 
commits that were involved with the clusterf--k.</p>
<p>The final state of the repo is:</p>
<pre><code>       D'   E' (new_master)
       o----o
      /
     /       (old history 
    o          is removed)
    A
</code></pre>

<p>Now delete the old <code>master</code> branch:</p>
<pre><code>git branch -D master
git push origin :master --force
</code></pre>

<p>Finally, push the <code>new_master</code> branch to the remote:</p>
<pre><code>git push origin new_master
</code></pre>

<p>Pat yourself on the back - you've successfully unf--ked 
the repository.</p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../transplant/" title="Performing Transplants with Patch" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Performing Transplants with Patch
              </span>
            </div>
          </a>
        
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 <a href="https://charlesreid1.com">Charles Reid</a>, released under the <a href="https://opensource.org/licenses/BSD-3-Clause">BSD 3-clause license</a>
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
        
      
    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../assets/javascripts/application.e72fd936.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:".."}})</script>
      
        <script src="../search/main.js"></script>
      
    
    
      
    
  </body>
</html>